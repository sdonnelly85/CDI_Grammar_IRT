---
title: Psychometric modeling of the Syntactic Complexity Scale of the CDI
author: Seamus Donnelly
date created: July 5, 2021
date compiled: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---


```{r message=FALSE, warning=FALSE}
library(wordbankr) # WB data
library(tidyverse) # tidy
library(mirt) # IRT models
library(ltm) # more IRT functions
library(psych) # some psychometric stuff (tests of dimensionality)
library(Gifi)# some more psychometric stuff (tests of dimensionality)
library(knitr) # some formatting, tables, etc
library(patchwork) # combining plots. 
library(GGally) # More plottinng options. 
library(lordif) # differential item functioning.
```

In our meeting on 01/09/2021, we discussed the possibility that our sample was a mixture of children, grammatical kids and pre-grammatical kids. We said one way to remove the pre-grammatical kids would be to exclude kids who have a 0 on the variable indicating whether children combine words, and on any of the morphological variables. One concern is whether kids who are not combining words but are using ing, ed or s. It's not clear whether these kids are pre-grammatical or not. 

I made a change to this script on 18/11/2021. I got rid of the wordform and over-regularization items. These were carried over from the previous script. 

Download data from Word Bank:
```{r get data}
Inst <- get_instrument_data(language="English (American)", form="WS")
Admin <- get_administration_data(language="English (American)", form="WS")
Item <- get_item_data(language="English (American)", form = "WS")
```

```{r}
Complex <- Admin %>%
  full_join(.,Inst, by="data_id") %>%
  full_join(., Item, by="num_item_id") %>%
  filter(longitudinal==FALSE) %>%
  filter(type == "combine" | 
           type == "complexity" |
           type == "word_endings" 
         ) %>%
  mutate(
    out = ifelse(value=="complex" | value=="sometimes" | value=="produces", yes=1, 
                 no = ifelse(value=="often", yes=2, no =0))
  ) 
```

As a quick sanity check, let's see which items have ordinal data (to make sure the above code worked correctly). 
```{r}
Complex %>%
  filter(out==2) %>%
  group_by(definition) %>%
  count()
```
Ok, it's only the combine variable and word endings variables -- that's right. 

## Data Screening
Let's see how many missing values there are. 
```{r count NAs}
Complex %>%
  filter(is.na(out)) %>%
  group_by(definition) %>%
  count() 
```
1426 participants are missing complexity items. 1403 are missing word endings. Let's see if any word endings are missing for participants who have complexity scores. 

```{r}
Complex %>%
  dplyr::select("data_id", "definition", "out") %>%
  pivot_wider(id_cols = data_id, 
              names_from = definition, 
              values_from = out) %>%
  filter(is.na(spossess) & !is.na(`two shoe / two shoes`))
```

So another 2 participants are missing word endings but have complexity scores. 

Make complexity category score, which will be used for making output easier to look at, 
```{r}
Complex$complexity_category <- ifelse(Complex$complexity_category == "", yes=Complex$type, no=Complex$complexity_category)
```


```{r Summary Tables}
Complex %>% 
  filter(!is.na(out)) %>%
  group_by(definition) %>%
  summarise(
    mean=mean(out), 
    sd=sd(out),
    sum=sum(out),
    category = first(complexity_category)
  ) %>%
  arrange(category) %>%
  kable(caption="Means and SDs for Each Item (Arranged by Item)")
```

```{r}
Complex %>%
  filter(!is.na(out)) %>%
  group_by(definition) %>%
  summarise(
    mean=mean(out), 
    category = first(complexity_category),
    cat2 = str_replace(category, "_", " " ) %>% str_replace("_", "\n" ) 
  ) %>%
  ggplot(aes(x=cat2, y= mean)) + geom_boxplot() 
```

## Data Preparation
Prepare data set for IRT modeling. I'm going to re-name each item to its category (morphology or syntax) and its item number so as to make some graphs easier to read. 

```{r}
Complex_short_with_ids <- Complex %>% 
  dplyr::select(data_id, value, out, complexity_category, num_item_id) %>%
  mutate(
    label = str_c(complexity_category, num_item_id)
  ) %>%
  pivot_wider(id_cols=data_id, names_from = "label", values_from="out") 


Complex_short <- Complex_short_with_ids %>%
  dplyr::select(starts_with(c("combine", "morphology", "syntax")), c("word_endings686", "word_endings687", "word_endings688", "word_endings689")) # dataset for IRT can't have IDs
```


Quick test of the possibility that some kids have a 0 for combine words but a 1 for something else. 
```{r}
Complex_short %>%
  filter(combine760==0) %>%
  dplyr::select(word_endings686, word_endings687, word_endings688, word_endings689) %>%
  mutate(
    total = word_endings686 + word_endings687 + word_endings688 +   word_endings689,
    morph = ifelse(total == 0, yes = 0, no =1)
  ) %>%
  group_by(morph) %>%
  count()
  
```
So, there are 600 kids with a 0 on combines words. Of those, 107 kids are producing morphological forms. I think it makes sense to be conservative about who's grammatical and exclude those 107 kids. I'm going to make two datasets for the IRT models: one including all participants and one including those who met our stringent definition of grammatical.

We'll now drop the word endings and NAs. 
```{r}
Complex_short <- Complex_short %>%
  dplyr::select(starts_with(c("combine", "morphology", "syntax"))) %>%
  drop_na()

nrow(Complex_short) == 4214 - 1426 # Just a quick sanity check. 
```


Now we'll make two datasets for the subsequent analyses: one with only participants who are combining words and one with kids who are not yet combining words. 
```{r}
Complex_short_grammatical <- Complex_short %>%
  filter(combine760 > 0) %>%
  dplyr::select(starts_with(c("morphology", "syntax")))

Complex_short_all <- Complex_short %>%
  dplyr::select(starts_with(c("morphology", "syntax")))
```

## Dimensionality Assessment
We'll do the inital dimensionality checks on both of these datasets. 

### First for grammatical kids only
Create tetrachoric correlation matrix (for binary data). I created a vector with labels, for labeling of the correlation plot. 
```{r}
Complex_tetra <- tetrachoric(Complex_short_grammatical)

rho <- Complex_tetra$rho

lab = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37") # create labels for corPlot because the defintions are long and take up a ton of space
```
Check out the correlations
```{r}
corPlot(rho, labels=lab)
```


```{r}
pc <- princals(rho)

plot(pc)
```
Princals suggests a few items are acting strangely. 
```{r , message=FALSE, error=FALSE}
fa.parallel(rho, fa="fa", cor="tetra", n.obs = 2188)
```


```{r}
vss(rho, cor="tetra", n.obs = 2188)
```

VSS and parallel analysis suggest 1 dimensional solution is okay, though there's a bit of multidimensionality in the Princals plot. 

### All Kids
```{r}
Complex_tetra <- tetrachoric(Complex_short_all)

rho <- Complex_tetra$rho

lab = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37") # create labels for corPlot because the defintions are long and take up a ton of space
```
Check out the correlations
```{r}
corPlot(rho, labels=lab)
```


```{r}
pc <- princals(rho)

plot(pc)
```

```{r , message=FALSE, error=FALSE}
fa.parallel(rho, fa="fa", cor="tetra", n.obs = 2788)
```


```{r , message=FALSE, error=FALSE}
vss(rho, cor="tetra", n.obs = 2788)
```

It seems like the one factor solution is most plausible for both the full data set and the dataset with grammatical kids. One obvious difference, though, is that in the princal plot for the grammatical data set a few items appeared to differ quite differently from the others. I'm first going to do some IRT with the grammatical-only data set, and I'm goig to see if those vectors were a quirk of the scaling

# IRT: Grammatical only
## 2pl model

```{r  message=FALSE, warning=FALSE}
m1 <- mirt(Complex_short_grammatical, 1, itemtype="2PL") 
```

```{r}
m1
```

```{r}
summary(m1)
```

Let's check the overall fit of the model. The chi square statistic here isn't super meaningful given the sample size.  
```{r}
M2(m1)
```

```{r}
itemfit(m1)
```
I'm going to use a p-value of .10 as a cut off, to be conservative about false negatives. 
```{r, message=FALSE, warning=FALSE}
misfit <- itemfit(m1) %>% # Get labels of mis-fitting items. 
  filter(p.S_X2 <= .10) %>%
  dplyr::select(item) %>%
  as.vector()

items_good <- dplyr::select(Complex_short_grammatical, -all_of(misfit$item)) # Well fitting items
items_bad <- dplyr::select(Complex_short_grammatical, all_of(misfit$item)) # Poorly fitting items

mod_fit <- mirt(items_good, 1, "2PL", verbose=FALSE) # Calculate factor scores using only the well fitting items. 
Theta <- fscores(mod_fit)
```

```{r}
IG762<- itemGAM(items_bad$morphology762, Theta)
IG764<- itemGAM(items_bad$morphology764, Theta)
IG771<- itemGAM(items_bad$morphology771, Theta)
IG783<- itemGAM(items_bad$syntax783, Theta)
IG792<- itemGAM(items_bad$syntax792, Theta)
```

```{r}
plot(IG762); plot(IG764); plot(IG771)
```

```{r}
plot(IG783); plot(IG792)
```

Look at the discrimination and difficulty parameters
```{r}
coefs_2pl <- coef(m1, as.data.frame = TRUE) %>% 
 t() %>%
  as_tibble() %>%
  dplyr::select(-c(149:150)) %>%
  pivot_longer(everything()) %>%
  tidyr::separate(, col=name, into=c("item", "parameter"), sep="([.])") %>%
  pivot_wider(id_cols=item, names_from=parameter, values_from=value) %>%
  dplyr::select(item, a1, d) %>%
  mutate(
   category =  gsub('[[:digit:]]+', '', item)
  )
  
ggplot(coefs_2pl,  
       aes(x = a1, y = d)) + 
  geom_point(alpha = .3) + 
  ggrepel::geom_text_repel(data = coefs_2pl, 
                  aes(label = item), size = 3) + 
  xlab("Discrimination") + 
  ylab("Difficulty") + theme_minimal()
```

```{r}
ggplot(coefs_2pl, aes(x=a1, fill=category)) + geom_histogram() + theme_minimal()
ggplot(coefs_2pl, aes(x=d, fill=category)) + geom_histogram() + theme_minimal()
```

Next let's look at the relationship between the true scores and the raw scores. 
```{r}
true_raw <- Complex_short_grammatical %>%
  mutate(
    Raw = rowSums(.[,1:37]), 
    Theta = fscores(m1)
  ) %>%
  ggplot(aes(x=Theta, y=Raw)) + geom_point() + stat_smooth(method="loess") + theme_minimal()

raw_score <- Complex_short_grammatical %>%
  mutate(
    Raw = rowSums(.[,1:37])
    ) %>% 
   ggplot(aes(x=Raw)) + geom_histogram() + theme_minimal()

true_score <- Complex_short_grammatical %>%
  mutate(
    Theta = fscores(m1)
    ) %>% 
   ggplot(aes(x=Theta)) + geom_histogram() + theme_minimal()

library(patchwork)

true_raw/(true_score + raw_score) 
```

We still have a bunch of 0s. 


## Thinking Through the Assumptions of the 2PL model 
Given the differences in dimensionality in the exploratory FA stuff above. It's important to assess the dimensionality of each of these datasets using the IRT models. 

### Dimensionality
Exploratory 2 dimensional IRT. 
```{r, warning=TRUE, message=TRUE}
m2 <- mirt(Complex_short_grammatical, 2, itemtype="2PL", verbose=FALSE)
```


```{r}
M2(m2)
anova(m1, m2)
summary(m2, "oblimin", suppress=.20)
```

```{r}
Complex_short_grammatical %>%
  mutate(
    Raw = rowSums(.[,1:37]), 
    Theta1 = fscores(m2)[,1], 
    Theta2 = fscores(m2)[,2]
  ) %>%
  dplyr::select(Raw, Theta1, Theta2) %>%
  ggpairs()

```

Could this be due to morphological vs syntactic complexity items?
```{r, warning=FALSE, message=FALSE}
model.1 <- mirt.model('
                      F1 = 1 - 12
                      F2 = 13 - 37
                      COV=F1*F2')

m3 <- mirt(Complex_short_grammatical, model.1, "2PL", verbose=FALSE)

M2(m3)

summary(m3)
```

```{r}
Complex_short_grammatical %>%
  mutate(
    Raw = rowSums(.[,1:37]), 
    Theta1 = fscores(m3)[,1], 
    Theta2 = fscores(m3)[,2]
  ) %>%
  dplyr::select(Raw, Theta1, Theta2) %>%
  ggpairs()

```



```{r}
M2(m3)
```

```{r}
anova(m3, m2)
anova(m3, m1)
```

### Semi-parametric latent variables. 
```{r, warning=TRUE, message=TRUE}
m1_nonpar <- mirt(Complex_short_grammatical, 1, itemtype="2PL", dentype = "EH", verbose=FALSE)

M2(m1_nonpar)
```

```{r}
Complex_short_grammatical %>%
  mutate(
    Theta_EH = fscores(m1_nonpar, use_dentype_estimate=TRUE), 
    Theta_gauss = fscores(m1)
  ) %>%
  ggplot(aes(x=Theta_EH, y=Theta_gauss)) + geom_point() + stat_smooth(method="loess") + theme_minimal()


```

# IRT: Grammatical only
## 2pl model

```{r  message=FALSE, warning=FALSE}
m4 <- mirt(Complex_short_all, 1, itemtype="2PL") 
```

```{r}
summary(m4)
```

```{r}
M2(m4)
```

```{r}
itemfit(m4)
```

```{r}
misfit <- itemfit(m4) %>% # Get labels of mis-fitting items. 
  filter(p.S_X2 <= .10) %>%
  dplyr::select(item) %>%
  as.vector()

items_good <- dplyr::select(Complex_short_grammatical, -all_of(misfit$item)) # Well fitting items
items_bad <- dplyr::select(Complex_short_grammatical, all_of(misfit$item)) # Poorly fitting items

mod_fit <- mirt(items_good, 1, "2PL", verbose=FALSE) # Calculate factor scores using only the well fitting items. 
Theta <- fscores(mod_fit)
```

```{r}
IG762<- itemGAM(items_bad$morphology762, Theta)
IG764<- itemGAM(items_bad$morphology764, Theta)
IG769<- itemGAM(items_bad$morphology769, Theta)
IG771<- itemGAM(items_bad$morphology771, Theta)
IG783<- itemGAM(items_bad$syntax783, Theta)
IG792<- itemGAM(items_bad$syntax792, Theta)
```


```{r}
plot(IG762); plot(IG764); plot(IG769); plot(IG771)
```

```{r}
plot(IG783); plot(IG792)
```

```{r}
coefs_2pl <- coef(m4, as.data.frame = TRUE) %>% 
 t() %>%
  as_tibble() %>%
  dplyr::select(-c(149:150)) %>%
  pivot_longer(everything()) %>%
  tidyr::separate(, col=name, into=c("item", "parameter"), sep="([.])") %>%
  pivot_wider(id_cols=item, names_from=parameter, values_from=value) %>%
  dplyr::select(item, a1, d) %>%
  mutate(
   category =  gsub('[[:digit:]]+', '', item)
  )

ggplot(coefs_2pl,  
       aes(x = a1, y = d)) + 
  geom_point(alpha = .3) + 
  ggrepel::geom_text_repel(data = coefs_2pl, 
                  aes(label = item), size = 3) + 
  xlab("Discrimination") + 
  ylab("Difficulty") + theme_minimal()
```
Distribution of IRT parameters is a bit more extreme than in the gramatical only dataset. 


```{r}
true_raw <- Complex_short_all %>%
  mutate(
    Raw = rowSums(.[,1:37]), 
    Theta = fscores(m4)
  ) %>%
  ggplot(aes(x=Theta, y=Raw)) + geom_point() + stat_smooth(method="loess") + theme_minimal()

raw_score <- Complex_short_all %>%
  mutate(
    Raw = rowSums(.[,1:37])
    ) %>% 
   ggplot(aes(x=Raw)) + geom_histogram() + theme_minimal()

true_score <- Complex_short_all %>%
  mutate(
    Theta = fscores(m4)
    ) %>% 
   ggplot(aes(x=Theta)) + geom_histogram() + theme_minimal()

library(patchwork)

true_raw/(true_score + raw_score) 
```
## Assumption Checking

### Dimensionality

```{r, warning=TRUE, message=TRUE}
m5 <- mirt(Complex_short_all, 2, itemtype="2PL", verbose=FALSE)
```


```{r}
M2(m5)
anova(m4, m5)
summary(m5, "oblimin", suppress=.20)
```

```{r}
Complex_short_all %>%
  mutate(
    Raw = rowSums(.[,1:37]), 
    Theta1 = fscores(m5)[,1], 
    Theta2 = fscores(m5)[,2]
  ) %>%
  dplyr::select(Raw, Theta1, Theta2) %>%
  ggpairs()

```

```{r}
model.1 <- mirt.model('
                      F1 = 1 - 12
                      F2 = 13 - 37
                      COV=F1*F2')

m6 <- mirt(Complex_short_all, model.1, "2PL", verbose=FALSE)

M2(m6)

summary(m6)
```

```{r, warning=TRUE, message=TRUE}
m4_nonpar <- mirt(Complex_short_all, 1, itemtype="2PL", dentype = "EH", verbose=FALSE)

```

```{r}
Complex_short_all %>%
  mutate(
    Theta_EH = fscores(m4_nonpar, use_dentype_estimate=TRUE), 
    Theta_gauss = fscores(m4)
  ) %>%
  ggplot(aes(x=Theta_EH, y=Theta_gauss)) + geom_point() + stat_smooth(method="loess") + theme_minimal()
```
Distribution looks pretty similar to other dataset. 


```{r}
```

```{r}
```
