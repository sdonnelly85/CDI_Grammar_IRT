---
title: Psychometric modeling of the Syntactic Vocabulary of the CDI
author: Seamus Donnelly
date created: July 5, 2021
date compiled: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---

Note to self: these models take a long time to run, so, rather than estimating them each time I run the code, I've saved the models, commented out teh code for running the models, and included the code for opening the models. Be **EXTRA CAREFUL** that the saved models are the most up to date. 


# Preliminaries
```{r  message=FALSE, warning=FALSE}
library(wordbankr) # WB data
library(tidyverse) # tidy
library(mirt) # IRT models
library(ltm) # more IRT functions
library(psych) # some psychometric stuff (tests of dimensionality)
library(Gifi)# some more psychometric stuff (tests of dimensionality)
library(knitr) # some formatting, tables, etc
library(patchwork) # combining plots. 
library(GGally) # More plottinng options. 
library(lordif) # differential item functioning.
```


```{r}
Inst <- get_instrument_data(language="English (American)", form="WS")
Admin <- get_administration_data(language="English (American)", form="WS")
N_total = nrow(Admin) # making sure things add up later
N_long = nrow(filter(Admin, longitudinal==TRUE)) # making sure things add up later
Item <- get_item_data(language="English (American)", form = "WS")
```


```{r format data}
Vocab <- Admin %>%
  full_join(.,Inst, by="data_id") %>%
  full_join(., Item, by="num_item_id") %>%
  filter(longitudinal==FALSE) %>% # remove longitudinal data set
  filter(type == "word"
         ) %>%
  mutate(
    out = ifelse(value=="produces", yes=1, no =0)
    )

N_vocab = nrow(filter(Item, type == "word")) 

nrow(Vocab) == (N_total - N_long)*N_vocab
```

```{r count NAs}
Vocab %>%
  filter(is.na(out)) %>%
  group_by(definition) %>%
  count()
```
Number of missing items differs by word. How can this be??

Check distribution of missing values by source. 
```{r}
Vocab %>%
  filter(is.na(out)) %>%
  group_by(source_name) %>%
  count()
```

These all seem to come from a single study (- 1). 
```{r}
Vocab %>%
  group_by(source_name) %>%
  count()
```
```{r}
Vocab %>%
 filter(is.na(out)) %>%
 filter(source_name=="Marchman (Outreach1)")
```
No idea why this word is missing. I'm removing all these participants from the IRT models. 

```{r}
N_missing <- Vocab %>%
  filter(is.na(out)) %>%
  group_by(data_id) %>%
  slice(1) %>%
  ungroup(data_id) %>%
  count()
```


```{r Summary Tables}
Vocab %>% 
  filter(!is.na(out)) %>%
  group_by(definition) %>%
  summarise(
    mean=mean(out), 
    sd=sd(out),
    category = first(lexical_category)
  ) %>%
  arrange(category) %>%
  kable(caption="Means and SDs for Each Item (Arranged by Item)")
```


```{r}
Vocab %>% 
  filter(!is.na(out)) %>%
  group_by(definition) %>%
  summarise(
    mean=mean(out), 
    sd=sd(out),
    category = first(lexical_category)
  ) %>%
  ggplot(aes(x=mean, fill=category)) + geom_histogram()
```

Stick to just nouns and predicates as these are relatively clearly not grammatical items.
```{r}
Vocab_short_with_ids <- Vocab %>% 
  filter(lexical_category == "nouns" | lexical_category == "predicates") %>%
  dplyr::select(data_id, value, out, definition) %>%
  pivot_wider(id_cols=data_id, names_from = "definition", values_from="out") %>%
  drop_na() # drop participants with missing data


Vocab_short <- Vocab_short_with_ids %>%
  dplyr::select(-"data_id") # dataset for IRT can't have IDs

nrow(Vocab_short_with_ids) == N_total - N_long - N_missing # Looks good
```


# Dimensionality assessment
I'm not going to bother with the correlation plot because I think it will be too difficult to visualize. 
```{r}
Complex_poly <- tetrachoric(Vocab_short)

rho <- Complex_poly$rho
```
These will not run. 
```{r}
#pc <- princals(rho)

#plot(pc)
```

```{r}
fa.parallel(rho, fa="fa", fm="minres", cor="poly", n.obs = 4186)
```


# One dimension
## 2PL Model
```{r}
#m1 <- mirt(Vocab_short, 1, itemtype="2PL") 
#saveRDS(m1, "vocab_output/m1.rds")
m1 <-  readRDS("vocab_output/m1.rds")
```
Looking at item misfit statistics
```{r}
#itf <- itemfit(m1)
#saveRDS(itf, "vocab_output/itf.rds")
itf <- readRDS("vocab_output/itf.rds")
```


```{r}
misfit <- itf  %>% # Get labels of mis-fitting items. 
  filter(p.S_X2 <= .01) %>%
  dplyr::select(item) %>%
  as.vector()

items_good <- dplyr::select(Vocab_short, -all_of(misfit$item)) # Well fitting items
items_bad <- dplyr::select(Vocab_short, all_of(misfit$item)) # Poorly fitting items

mod_fit <- mirt(items_good, 1, "2PL", verbose=FALSE) # Calculate factor scores using only the well fitting items. 
Theta <- fscores(mod_fit)
```

```{r, fig.show="hold", out.width="50%"}
plot(itemGAM(items_bad$dog, Theta)) %>% update(main = "dog")
plot(itemGAM(items_bad$donkey,Theta)) %>% update(main = "donkey")
plot(itemGAM(items_bad$teddybear,Theta)) %>% update(main = "teddybear")
plot(itemGAM(items_bad$block,Theta)) %>% update(main = "block")
plot(itemGAM(items_bad$doll,Theta)) %>% update(main = "doll")
plot(itemGAM(items_bad$`toy (object)`,Theta)) %>% update(main = "toy (object)")
plot(itemGAM(items_bad$beans,Theta)) %>% update(main = "beans") 
plot(itemGAM(items_bad$raisin,Theta)) %>% update(main = "raisin") 
plot(itemGAM(items_bad$underpants,Theta)) %>% update(main = "underpants") 
plot(itemGAM(items_bad$`penis*`,Theta)) %>% update(main = "penis") 
plot(itemGAM(items_bad$`vagina*`,Theta)) %>% update(main = "vagina")
plot(itemGAM(items_bad$clock,Theta)) %>% update(main = "clock") 
plot(itemGAM(items_bad$dish,Theta)) %>% update(main = "dish")
plot(itemGAM(items_bad$keys,Theta)) %>% update(main = "keys")
plot(itemGAM(items_bad$plate,Theta)) %>% update(main = "plate")
plot(itemGAM(items_bad$trash,Theta)) %>% update(main = "trash")
plot(itemGAM(items_bad$bathtub,Theta)) %>% update(main = "bathtub")
plot(itemGAM(items_bad$TV,Theta)) %>% update(main = "TV")
```


```{r, fig.show="hold", out.width="50%"}
plot(itemGAM(items_bad$catch, Theta)) %>% update(main = "catch")
plot(itemGAM(items_bad$fit,Theta))  %>% update(main = "fit")
plot(itemGAM(items_bad$get,Theta)) %>% update(main = "get")
plot(itemGAM(items_bad$go,Theta)) %>% update(main = "go")
plot(itemGAM(items_bad$read,Theta)) %>% update(main = "read")
```

```{r}
true_raw <- Vocab_short %>%
  mutate(
    Raw = rowSums(.[,1:478]), 
    Theta = fscores(m1)
  ) %>%
  ggplot(aes(x=Theta, y=Raw)) + geom_point() + stat_smooth(method="loess") + theme_minimal()

raw_score <- Vocab_short %>%
  mutate(
    Raw = rowSums(.[,1:478])
    ) %>% 
   ggplot(aes(x=Raw)) + geom_histogram() + theme_minimal()

true_score <- Vocab_short %>%
  mutate(
    Theta = fscores(m1)
    ) %>% 
   ggplot(aes(x=Theta)) + geom_histogram() + theme_minimal()

library(patchwork)

true_raw/(true_score + raw_score) 
```



```{r}
coefs_2pl <- coef(m1, as.data.frame = TRUE) %>% 
 t() %>%
  as_tibble() %>%
  dplyr::select(-c(1913:1914)) %>%
  pivot_longer(everything()) %>%
  tidyr::separate(, col=name, into=c("item", "parameter"), sep="([.])") %>%
  filter(parameter == "a1" | parameter == "d" ) %>%
  pivot_wider(id_cols=item, names_from=parameter, values_from=value) 

ggplot(coefs_2pl,  
       aes(x = a1, y = -d)) + # Note in the book they use -d here, I think MIRT outputs a1 and an easiness rather than a difficulty. 
  geom_point(alpha = .3) + 
  ggrepel::geom_text_repel(data = coefs_2pl, 
                  aes(label = item), size = 3) + 
  xlab("Discrimination") + 
  ylab("Difficulty") + theme_minimal()
```



```{r}
#ggplot(coefs_2pl, aes(x=a1, fill=lexical_category)) + geom_histogram() + theme_minimal()
#ggplot(coefs_2pl, aes(x=d, fill=lexical_category)) + geom_histogram() + theme_minimal()
```

## Try changing to a non-parametric link function
These discrimination parameters look good, but I'm not crazy about the item response functions, so I will try a spline model .
```{r}
#m2 <- mirt(Vocab_short, 1, "spline", technical=list(NCYCLES = 1000)) # I can increase iterations, but it just jumps around the same few values. 
#saveRDS(m2, "vocab_output/m2.rds")
m2 <-  readRDS("vocab_output/m2.rds")
```


Plot latent variables of spline model against 2PL model. 
```{r}
Vocab_short %>%
  mutate(
    Raw = rowSums(.[,1:478]), 
    Theta_2pl = fscores(m1)[,1], 
    Theta_spline = fscores(m2)[,1]
  ) %>%
  dplyr::select("Raw", "Theta_2pl", "Theta_spline") %>%
  ggpairs()
```


## Try other latent variable
```{r}
#m3 <- mirt(Vocab_short, 1, dentype="EH",  technical=list(NCYCLES = 2000)) 
#saveRDS(m3, "vocab_output/m3.rds")
m3 <- readRDS("vocab_output/m3.rds")
```

```{r}
Vocab_short %>%
  mutate(
    Raw = rowSums(.[,1:478]), 
    Theta_2pl = fscores(m1)[,1], 
    Theta_spline = fscores(m2, use_dentype_estimate=TRUE)[,1], 
    Theta_EH =  fscores(m3, use_dentype_estimate=TRUE)[,1]
  ) %>%
  dplyr::select("Raw", "Theta_2pl", "Theta_spline", "Theta_EH") %>%
  ggpairs()
```

Compare the shape of distribution of latent variables. 
```{r}
(dens_plot <- Vocab_short %>%
  mutate(
    Theta_logit = fscores(m1)[,1], # Used MAP here, but EAP gives same results. 
    Theta_spline = fscores(m2, use_dentype_estimate=TRUE)[,1],
    Theta_EH = fscores(m3, use_dentype_estimate=TRUE)[,1]
  ) %>%
  dplyr::select("Theta_logit", "Theta_spline", "Theta_EH") %>%
  pivot_longer(everything(), names_to="model", values_to="theta") %>%
  ggplot(aes(x=theta, fill=model)) + geom_density(alpha = .2) +
  ggtitle("Distribution of Theta"))
```

```{r}
Theta <- matrix(seq(-4,4,.01))
m1_inf <- testinfo(m1, Theta)
#mspline_inf <- testinfo(m2, Theta)
mEH_inf <- testinfo(m3, Theta)


(info_plot <- tibble(Theta, m1_inf, mEH_inf) %>%
   pivot_longer(c("m1_inf", "mEH_inf"), names_to = "LV", values_to = "Info") %>%
  mutate(
    model = ifelse(LV == "m1_inf", yes="2PL", no ="EH")
  ) %>%
  ggplot(aes(x=Theta, y=Info, group=model, color=model)) + geom_line() +
  ggtitle("Test Information"))

```


```{r}
coefs_2pl <- coef(m3, as.data.frame = TRUE) %>% 
 t() %>%
  as_tibble() %>%
  dplyr::select(-c(1913:1914)) %>%
  pivot_longer(everything()) %>%
  tidyr::separate(, col=name, into=c("item", "parameter"), sep="([.])") %>%
  filter(parameter == "a1" | parameter == "d" ) %>%
  pivot_wider(id_cols=item, names_from=parameter, values_from=value) 

ggplot(coefs_2pl,  
       aes(x = a1, y = -d)) + # Note in the book they use -d here, I think MIRT outputs a1 and -d
  geom_point(alpha = .3) + 
  ggrepel::geom_text_repel(data = coefs_2pl, 
                  aes(label = item), size = 3) + 
  xlab("Discrimination") + 
  ylab("Difficulty") + theme_minimal()
```


# Add a dimension
Compare this to a model with 2 dimensions. 
```{r}
#m4<- mirt(Vocab_short, 2, itemtype="2PL", technical=list(NCYCLES = 4000)) 
#saveRDS(m4, "vocab_output/m4.rds")
m4 <-  readRDS("vocab_output/m4.rds")
```

```{r}
summary(m4, "oblimin", suppress=.20)
```

```{r}
anova(m4, m1)
```

```{r}
Vocab_short %>%
  mutate(
    Raw = rowSums(.[,1:478]), 
    Theta1 = fscores(m4)[,1], 
    Theta2 = fscores(m4)[,2]
  ) %>%
  dplyr::select(Raw, Theta1, Theta2) %>%
  ggpairs()

```

Second factor doesn't look like it's doing much work. 

```{r}
model.1 <- mirt.model('
                      F1 = 1 - 312
                      F2 = 313 - 478
                      COV=F1*F2')

#m5 <- mirt(Vocab_short, model.1, "2PL")


#summary(m5)

#saveRDS(m5, "vocab_output/m5.rds")
m5 <-  readRDS("vocab_output/m5.rds")
```


```{r}
anova(m5, m1)
```

```{r}
Vocab_short %>%
  mutate(
    Raw = rowSums(.[,1:478]), 
    Theta1 = fscores(m5)[,1], 
    Theta2 = fscores(m5)[,2]
  ) %>%
  dplyr::select(Raw, Theta1, Theta2) %>%
  ggpairs()

```


```{r}
Vocab_with_predictors <- Admin %>%
  dplyr::select(data_id, age, ethnicity, sex, mom_ed) %>%
  mutate(
    female = ifelse(sex=="Female", yes=1, no=0),
   age_y = ifelse(age < 25, yes=1, no=0),
   college_grad = ifelse(mom_ed %in% c("College", "Some Graduate",  "Some Graduate"), yes=1, no=0)
   ) %>%
  right_join(., Vocab_short_with_ids, by="data_id")
```


```{r}
Vocab_with_predictors %>%
  summarise(
    age_missing = sum(is.na(age)), 
    ethnicity_missing = sum(is.na(ethnicity)), # Some ethnicity variables missing. 
    sex_missing = sum(is.na(sex)), 
    college_grad = sum(is.na(college_grad))
  )

table(Vocab_with_predictors$age)
table(Vocab_with_predictors$ethnicity)
table(Vocab_with_predictors$sex)
table(Vocab_with_predictors$college_grad)
```

```{r}
#Vocab_short2 <- data.frame(Vocab_short) 

#dif <- lordif(Vocab_short2, 
#              Vocab_with_predictors$female,
#              criterion="Chisqr", 
#              alpha = .01)

#saveRDS(dif, "vocab_output/dif.rds")
dif  <- readRDS("vocab_output/dif.rds")
```

```{r}
dif
```

```{r}
plot(dif)
```
A lot o items were flagged, but given the relatively small values of the difference between initial and pure variables I'm not overly concerned. 
```{r}
#dif2 <- lordif(Vocab_short2, 
#              Vocab_with_predictors$college_grad,
#              criterion="Chisqr", 
#              alpha = .01)
#saveRDS(dif2, "vocab_output/dif2.rds")
dif2  <- readRDS("vocab_output/dif2.rds")
```

```{r}
plot(dif2)
```

```{r}
Theta_logit <- fscores(m1, use_dentype_estimate=TRUE, full.scores.SE=TRUE) %>%
  as_tibble() %>%
  rename(Vocab_F = F1, Vocab_SE = SE_F1)
```

```{r}
ggplot(Theta_logit, aes(x=M1_F, M1_SE)) + geom_point()
```

```{r}
Theta_EH <- fscores(m3, use_dentype_estimate=TRUE, full.scores.SE=TRUE) %>%
  as_tibble() %>%
  rename(M3_F = F1, M3_SE = SE_F1)

ggplot(Theta_EH, aes(x=M3_F, M3_SE)) + geom_point()
```

```{r}
Final_vocab <- Vocab_with_predictors %>%
  mutate(
    Total_Vocab = rowSums(.[,9:486])
  ) %>%
 dplyr::select(data_id, Total_Vocab) %>%
  bind_cols(., Theta_logit)
```

```{r}
ggplot(Final_vocab, aes(x=Vocab_F, y=Total_Vocab)) + geom_point()
```

```{r}
write.csv(Final_vocab, "files/vocab.csv")
```

```{r}
```

