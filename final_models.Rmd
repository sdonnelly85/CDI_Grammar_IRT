---
title: Looking at relationship between vocabulary and grammar.
author: Seamus Donnelly
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---

# Preliminaries  
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(brms)
library(patchwork)
library(rstatix)
```

## Open datasets and generate summary statistics. 
These data sets contain the vocabulary and grammar factor scores from the IRT models.
```{r message=FALSE, warning=FALSE}
vocab <- read_csv("files/vocab.csv")
grammar <- read_csv("files/grammar.csv")
complete <- left_join(grammar, vocab, by="data_id")

complete %>%
  dplyr::select(-"data_id") %>%
  get_summary_stats(type="common") # vocab only open classed items (nouns and predicates)
```

One Grammar LV wasn't matched to Vocabulary (they were missing a value for 1 word; see script on vocabulary) I doubt it makes a difference. 
```{r}
complete <- complete %>%
  filter(!is.na(Total_Vocab))
```


```{r}
grammar_dens <- complete %>%
  dplyr::select("M1_F", "M2_F") %>%
  rename(M1 = M1_F, M2=M2_F) %>%
  pivot_longer(everything(), names_to="Model", values_to="Theta") %>%
  ggplot(aes(x=Theta, fill=Model)) + geom_density(alpha = .2) +
  ggtitle("Distribution of Theta")  + theme_minimal()

vocab_dens <- complete %>%
  rename(Theta=Vocab_F) %>%
  ggplot(aes(x=Theta)) + geom_density(alpha = .2) +
  ggtitle("Distribution of Theta") + theme_minimal()

```

```{r}
grammar_se <- complete %>%
  dplyr::select("M1_F", "M2_F", "M1_SE", "M2_SE") %>%
  pivot_longer(everything(),
  names_to = c("Model", ".value"),
  names_pattern = "(.+)_(.+)" 
  ) %>%
  rename(Theta=`F`) %>%
  ggplot(aes(x=Theta, y=SE, colour=Model)) + geom_point() + ggtitle("Standard Errors") +theme_minimal()

vocab_se <- complete %>%
  dplyr::select(Theta= "Vocab_F", SE = "Vocab_SE") %>%
 ggplot(aes(x=Theta, y=SE)) + geom_point() + ggtitle("Standard Errors") +theme_minimal()

p1 <- grammar_dens + grammar_se + plot_layout(guides = "collect")

ggsave("plots/thetaSE_g.png", last_plot(), width=6, height=4, units="in", dpi=400)

p2 <- vocab_dens  + vocab_se
ggsave("plots/thetaSE_v.png", last_plot(), width=6, height=4, units="in", dpi=400)
```

# Fit Models to Raw data

Fit linear model to the raw data. 
```{r}
m1 <- brm(total ~ Total_Vocab, data=complete, file="bayes_models/m1.rds")
summary(m1)
```
The posterior predictive distribution fits poorly. 

Add smoothing. 
```{r}
m2 <- brm(total ~ s(Total_Vocab), data=complete, file="bayes_models/m2.rds")
summary(m2)
```
This still fits poorly, though it's definitely a bit better. 

Let's compare the two models. 
```{r}
loo(m1, m2)
```

The model with the spline fits better. 

Change likelihood to poisson
```{r}
m3 <- brm(total ~ s(Total_Vocab), family="poisson", data=complete, file="bayes_models/m3.rds")
summary(m3)
```
Plot predictions from all three models against the raw data
```{r}
p3 <- plot(conditional_effects(m1), points=TRUE)
p4 <- plot(conditional_effects(m2), points=TRUE)
p5 <- plot(conditional_effects(m3), points=TRUE)
```

# Fit models full dataset: 

## 2pl model

Plot factors against one another
```{r}
ggplot(complete, aes(x=Vocab_F, y=M1_F)) + geom_point() + stat_smooth(method="loess")
```
Factor scores -- no error (just for completeness)
```{r}
m4 <- brm(M1_F ~ Vocab_F, data=complete, file="bayes_models/m4.rds")
summary(m4) 
```

Add error for grammar factor score. 
```{r}
m5 <- brm(M1_F | mi(M1_SE) ~ Vocab_F, data=complete, save_mevars = TRUE, file="bayes_models/m5.rds")
summary(m5)
```

Make shrinkage dataset for plots (see below)
```{r}
d1 <- tibble(
  ID = complete %>% pull(data_id),
  G1_obs = complete %>% pull(M1_F),
  V1_obs = complete %>% pull(Vocab_F), 
  G1_est = posterior_summary(m5) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "Observed", "Posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Linear")

```


I can, in principle, add measurement error to both latent variables, but I can't get this to run yet. Maybe try higher adapt delta, which seems to clean things up a bit, but will take some time to run. 
```{r}
#m6 <- brm(M1_F | mi(M1_SE) ~ me(Vocab_F, Vocab_SE), data=complete, save_mevars = TRUE, control=list(adapt_delta=.999, max_treedepth=15), file="bayes_models/m6.rds")
#summary(m6)
#posterior_summary(m6) %>%
#  round(2)
```

Fit model with spline for comparison. 
```{r}
m7 <- brm(M1_F | mi(M1_SE) ~ s(Vocab_F), data=complete, save_mevars = TRUE, file="bayes_models/m7.rds")
summary(m7)
```
Create other dataset and make plot comparing shrinkage across the two models. 
```{r}
d2 <- tibble(
  ID = complete %>% pull(data_id),
  G1_obs = complete %>% pull(M1_F),
  V1_obs = complete %>% pull(Vocab_F), 
  G1_est = posterior_summary(m7) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "Observed", "Posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Spine")


d3 <- bind_rows(d1, d2)

p6 <- ggplot(d3, aes(x=Vocab, y = Grammar)) +
  geom_line(aes(group = ID),
            size = 1/4) +
  geom_point(aes(color = Value)) +
  facet_wrap(~Model) + theme_minimal()

ggsave("plots/measure1_gauss.png", last_plot(), height=4, width=6, unit="in", dpi=300)
```

```{r}
loo(m5, m7)
```
Spline model fits substantially better. 

### Add Age to see if that adds more information around the ceiling and the floor. 
```{r}
m5age <- brm(M1_F | mi(M1_SE) ~ Vocab_F + age, data=complete, save_mevars = TRUE, file="bayes_models/m5age.rds")
summary(m5age)
```
```{r}
m7age <- brm(M1_F | mi(M1_SE) ~ s(Vocab_F) + age, data=complete, save_mevars = TRUE, file="bayes_models/m7age.rds")
summary(m7age)
```

```{r}
loo(m5age, m7age)
```

Roughly the same results. 

## EH Model
```{r}
ggplot(complete, aes(x=Vocab_F, y=M2_F)) + geom_point() + stat_smooth(method="loess")
```

```{r}
m8 <- brm(M2_F ~ Vocab_F, data=complete, file="bayes_models/m8.rds")
summary(m8) 
```

```{r}
m9 <- brm(M2_F | mi(M2_SE) ~ Vocab_F, save_mevars = TRUE,  data=complete, file="bayes_models/m9.rds")
summary(m9)
```


```{r}
m10 <- brm(M2_F | mi(M2_SE) ~ s(Vocab_F), save_mevars = TRUE,  data=complete, file="bayes_models/m10.rds")
summary(m10)
```

```{r}
d1 <- tibble(
  ID = complete %>% pull(data_id),
  G1_obs = complete %>% pull(M1_F),
  V1_obs = complete %>% pull(Vocab_F), 
  G1_est = posterior_summary(m9) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "Observed", "Posterior")
    ) %>% 
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Linear")
```

```{r}
d2 <- tibble(
  ID = complete %>% pull(data_id),
  G1_obs = complete %>% pull(M1_F),
  V1_obs = complete %>% pull(Vocab_F), 
  G1_est = posterior_summary(m10) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
    Value = ifelse(name == "G1_obs", "Observed", "Posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Spline")

d3 <- bind_rows(d1, d2)

p7 <- ggplot(d3, aes(x=Vocab, y = Grammar)) +
  geom_line(aes(group = ID),
            size = 1/4) +
  geom_point(aes(color = Value)) +
  facet_wrap(~Model) + theme_minimal()

ggsave("plots/measure1_EH.png", last_plot(), height=4, width=6, unit="in", dpi=300)
```

```{r}
loo(m9, m10)
```


### Add age
```{r}
m9age <- brm(M2_F | mi(M2_SE) ~ Vocab_F + age, save_mevars = TRUE,  data=complete, file="bayes_models/m9age.rds")
summary(m9age)
```


```{r}
m10age <- brm(M2_F | mi(M2_SE) ~ s(Vocab_F) + age, save_mevars = TRUE,  data=complete, file="bayes_models/m10age.rds")
summary(m10age)
pp_check(m10age)
```

```{r}
loo(m9age, m10age)
```

# Drop floor and ceiling cases. 

It's not clear if the curvilinear relationship above is due to actual curvilinearity or if the ceiling and floor are still pulling the trend around. I'll try removing observations right at the ceiling and floor and seeing that the results change. 

```{r}
complete %>%
  summarise(
    min = min(M1_F), 
    max = max(M1_F)
  )
```


## 2PL model
```{r}
m11 <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M1_F | mi(M1_SE) ~ Vocab_F, ., save_mevars = TRUE, file = "bayes_models/m11.rds")
summary(m11)
```


```{r}
d1 <- tibble(
  ID = filter(complete, M1_F > -1	& M1_F < 2) %>% pull(data_id),
  G1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(M1_F),
  V1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(Vocab_F), 
  G1_est = posterior_summary(m11) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "Observed", "Posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Linear")
```

```{r}
m12 <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M1_F | mi(M1_SE) ~ s(Vocab_F), ., save_mevars = TRUE, file = "bayes_models/m12.rds")
summary(m12)
```

```{r}
d2 <- tibble(
  ID = filter(complete, M1_F > -1	& M1_F < 2) %>% pull(data_id),
  G1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(M1_F),
  V1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(Vocab_F), 
  G1_est = posterior_summary(m12) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "Observed", "Posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Spline")


d3 <- bind_rows(d1, d2)

p8 <- ggplot(d3, aes(x=Vocab, y = Grammar)) +
  geom_line(aes(group = ID),
            size = 1/4) +
  geom_point(aes(color = Value)) +
  facet_wrap(~Model) + theme_minimal()

ggsave("plots/measure2_gauss.png", last_plot(), height=4, width=6, unit="in", dpi=300)
```

```{r}
loo(m11, m12)
```
### Add age

```{r}
m11age <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M1_F | mi(M1_SE) ~ Vocab_F + age, ., save_mevars = TRUE, file = "bayes_models/m11age.rds")
summary(m11age)
pp_check(m11age)
```

```{r}
m12age <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M1_F | mi(M1_SE) ~ s(Vocab_F) + age, ., save_mevars = TRUE, file = "bayes_models/m12age.rds")
summary(m12age)
pp_check(m12age)
```

```{r}
loo(m11age, m12age)
```


## EH Model
```{r}
m13 <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M2_F | mi(M2_SE) ~ Vocab_F, ., save_mevars = TRUE, file = "bayes_models/m13.rds")
summary(m13)
```


```{r}
m14 <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M2_F | mi(M2_SE) ~ s(Vocab_F), ., save_mevars = TRUE, file = "bayes_models/m14.rds")
summary(m14)
```

```{r}
d1 <- tibble(
  ID = filter(complete, M1_F > -1	& M1_F < 2) %>% pull(data_id),
  G1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(M1_F),
  V1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(Vocab_F), 
  G1_est = posterior_summary(m13) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "observed", "posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Linear")

d2 <- tibble(
  ID = filter(complete, M1_F > -1	& M1_F < 2) %>% pull(data_id),
  G1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(M1_F),
  V1_obs = filter(complete, M1_F > -1	& M1_F < 2)  %>% pull(Vocab_F), 
  G1_est = posterior_summary(m14) %>%
    data.frame() %>%
    rownames_to_column("term") %>%
    filter(str_detect(term, "Yl")) %>%
    pull(Estimate)) %>%
    pivot_longer(-c(ID, V1_obs), values_to="g") %>%
    mutate(
      Value = ifelse(name == "G1_obs", "observed", "posterior")
    ) %>%
  rename(Grammar = g, Vocab = V1_obs) %>%
  mutate(Model = "Spline")

d3 <- bind_rows(d1, d2)


p9 <- ggplot(d3, aes(x=Vocab, y = Grammar)) +
  geom_line(aes(group = ID),
            size = 1/4) +
  geom_point(aes(color = Value)) +
  facet_wrap(~Model) + theme_minimal()

ggsave("plots/measure2_EH.png", last_plot(), height=4, width=6, unit="in", dpi=300)
```

```{r}
loo(m13, m14)
```

### Add age
```{r}
m13age <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M2_F | mi(M2_SE) ~ Vocab_F + age, ., save_mevars = TRUE, file = "bayes_models/m13age.rds")
summary(m13age)
pp_check(m13age)
```


```{r}
m14age <- complete %>%
  filter(M1_F > -1	& M1_F < 2) %>%
  brm(M2_F | mi(M2_SE) ~ s(Vocab_F) + age, ., save_mevars = TRUE, file = "bayes_models/m14age.rds")
summary(m14age)
pp_check(m14age)
```

```{r}
loo(m13age, m14age)
```

```{r}
#m13 <- complete %>%
#  filter(M1_F > -1	& M1_F < 2) %>%
#  brm(M1_F | mi(M1_SE) ~ me(Vocab_F, Vocab_SE), ., file = "bayes_models/m13.rds", 
#      control=list(adapt_delta = .95, max_treedepth = 15))
```


