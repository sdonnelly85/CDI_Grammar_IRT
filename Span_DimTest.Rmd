---
title: "Dimensionality Assessment of CDI Data Spanish"
output:
  html_document:
    df_print: paged
---



```{r, message=FALSE,warning=FALSE}
library(readr)
library(knitr)
library(tidyverse)
library(ggplot2)
library(psych)
library(sirt)
library(Gifi)
```
# Data Prep
```{r}
Inst <- read_rds("Wordbank_Data/Inst_WS_Span.rds") # needs to be saved as rds - csv conflates "" and NA 
Admin <- read_rds("Wordbank_Data/Admin_WS_Span.rds")
N_total = nrow(Admin) 
N_long = nrow(filter(Admin, longitudinal==TRUE))
Item <- read_rds("Wordbank_Data/Item_WS_Span.rds")
```

## Make Complexity Data
```{r}
Complex <- Admin %>%
  full_join(.,Inst, by="data_id") %>%
  full_join(., Item, by="num_item_id") %>%
  filter(longitudinal==FALSE) %>%
  filter(type == "combine" | # to drop non-combiners
           type == "complexity" # to calculate complexity scores.
         ) %>%
  mutate(
    out = ifelse(value=="yes" | value=="produces" | value=="complex", yes=1, no=0)
  ) 

N_complexity_items = nrow(filter(Item, type == "combine" | 
           type == "complexity"))

nrow(Complex) == (N_total - N_long)*N_complexity_items
```

```{r}
Complex_short_with_ids_all <- Complex %>% 
  dplyr::select(data_id, type, value, out, num_item_id) %>%
  mutate(
    label = str_c(type, num_item_id)
  ) %>%
  pivot_wider(id_cols=data_id, names_from = "label", values_from="out") %>%
  dplyr::select(starts_with(c("data_id", "combine", "complexity"))) 

Complex_short_with_ids <- Complex_short_with_ids_all %>%  
drop_na()

N_NA <- nrow(Complex_short_with_ids_all) - nrow(Complex_short_with_ids)

Complex_short_grammatical <- Complex_short_with_ids %>%
  filter(combine710 > 0) %>%
  dplyr::select(starts_with(c("complexity"))) # need to get rid of participant names for IRT models. 

N_nog <- nrow(filter(Complex_short_with_ids, combine710 == 0))

nrow(Complex_short_grammatical) == N_total - N_long - N_NA - N_nog
```

### Some quick visualizations of grammar on its own
```{r}
#Complex_tetra <- tetrachoric(Complex_short_grammatical)

#rhog <- Complex_tetra$rho
#write_rds(rhog, "PreReg_Analyses/Span_output/rhog.rds") #Commented out because model resuls are saved
```
```{r}
rhog <- readRDS("PreReg_Analyses/Span_output/rhog.rds")
```

```{r}
corPlot(rhog)
```

```{r}
fa.parallel(rhog, fa="fa", cor="tetra", n.obs = 775)
```

```{r}
plot(princals(rhog))
```


```{r}
#m0a <- expl.detect(full2, nclusters=2, use_sum_score=TRUE, seed=1)
#m0b <- expl.detect(full2, nclusters=2, use_sum_score=TRUE, seed=347)
#m0c <- expl.detect(full2, nclusters=2, use_sum_score=TRUE, seed=4861)
#m0d <- expl.detect(full2, nclusters=2, use_sum_score=TRUE, seed=6789)


#write_rds(m0a, "PreReg_Analyses/Span_output/m0a.rds")
#write_rds(m0b, "PreReg_Analyses/Span_output/m0b.rds")
#write_rds(m0c, "PreReg_Analyses/Span_output/m0c.rds")
#write_rds(m0d, "PreReg_Analyses/Span_output/m0d.rds")

m0a<- read_rds("PreReg_Analyses/Span_output/m0a.rds")
m0b<- read_rds("PreReg_Analyses/Span_output/m0b.rds")
m0c<- read_rds("PreReg_Analyses/Span_output/m0c.rds")
m0d<- read_rds("PreReg_Analyses/Span_output/m0d.rds")

m0a$detect.unweighted
m0b$detect.unweighted
m0c$detect.unweighted
m0d$detect.unweighted
```

## Make Vocab Data

```{r}
Admin %>% # Start with new administration dataset.
  left_join(.,Inst, by="data_id") %>%
  left_join(., Item, by="num_item_id") %>%
  filter(longitudinal==FALSE) %>%
  filter(type == "word"
         ) %>%
  group_by(value) %>%
  count()
```

```{r}
Vocab <- Admin %>% # Start with new administration dataset.
  left_join(.,Inst, by="data_id") %>%
  left_join(., Item, by="num_item_id") %>%
  filter(longitudinal==FALSE) %>%
  filter(type == "word"
         ) %>%
  mutate(
    out = ifelse(value=="produces", yes=1, no =0)
    ) 

N_vocab = nrow(filter(Item, type == "word")) 

nrow(Vocab) == (N_total - N_long)*N_vocab 
```

```{r}
Vocab_short_with_ids_all <- Vocab %>% 
  filter(lexical_category == "nouns" | lexical_category == "predicates") %>%
  dplyr::select(data_id, value, out, definition) %>%
  pivot_wider(id_cols=data_id, names_from = "definition", values_from="out") 

Vocab_short_with_ids <- Vocab_short_with_ids_all %>% 
  drop_na()


N_NA_vocab <- nrow(Vocab_short_with_ids_all) - nrow(Vocab_short_with_ids)

Vocab_short <- Vocab_short_with_ids %>%
  dplyr::select(-"data_id") # dataset for IRT can't have IDs

nrow(Vocab_short_with_ids) == N_total - N_long - N_NA_vocab  # total vocab = original - longitudinal - NAs
```


## Make Full Data
```{r}
full <- full_join(
  Complex_short_with_ids, Vocab_short_with_ids, by="data_id"
) %>%
  filter(combine710 > 0) %>%
  dplyr::select(-c("data_id", "combine710")) %>%
  drop_na()
```

# Some quick checks of dimensionality: Full Data

Lot's of smoothing done on tetrachoric matrix. I think this is okay for visualization, but definitely not inference. 
```{r}
#full_tetra <- tetrachoric(full)

#rho <- full_tetra$rho
#write_rds(rho, "PreReg_Analyses/Span_output/rho.rds")
```

```{r}
rho <- read_rds("PreReg_Analyses/Span_output/rho.rds")
```

```{r}
fa.parallel(rho, fa="fa", fm="minres", cor="tetra", n.obs = 775) # takes a long time to run. Couldn't figure out an easy way to save the output and then view it as a plot. 
```

```{r}
#dtct <- c(rep(1, 37), rep(2, 478))

full2 <- data.frame(full)
fscores = rowSums(full)

#conf <- conf.detect(full2, fscores,  dtct)
#write_rds(conf, "PreReg_Analyses/Span_output/conf1.rds")

conf <- read_rds("PreReg_Analyses/Span_output/conf1.rds")
```

Select use_sum_score = TRUE
```{r}
#conf2 <- conf.detect(full2, fscores,  dtct, use_sum_score=TRUE)

#write_rds(conf2, "PreReg_Analyses/Span_output/conf2.rds")

conf2 <- read_rds("PreReg_Analyses/Span_output/conf2.rds")
```

```{r}
summary(conf)
summary(conf2)
```

Exploratory Detect. I have found that results of these analyses vary a bit with the seed, so I'm varying the seed here and seeing what happens. 
```{r}
m1 <- expl.detect(full2, fscores, nclusters=2, use_sum_score=TRUE, seed=1)
m2 <- expl.detect(full2, fscores, nclusters=2, use_sum_score=TRUE, seed=347)
m3 <- expl.detect(full2, fscores, nclusters=2, use_sum_score=TRUE, seed=4861)
m4 <- expl.detect(full2, fscores, nclusters=2, use_sum_score=TRUE, seed=6789)


write_rds(m1, "PreReg_Analyses/Span_output/m1.rds")
write_rds(m2, "PreReg_Analyses/Span_output/m2.rds")
write_rds(m3, "PreReg_Analyses/Span_output/m3.rds")
write_rds(m4, "PreReg_Analyses/Span_output/m4.rds")

m1<- read_rds("PreReg_Analyses/Span_output/m1.rds")
m2<- read_rds("PreReg_Analyses/Span_output/m2.rds")
m3<- read_rds("PreReg_Analyses/Span_output/m3.rds")
m4<- read_rds("PreReg_Analyses/Span_output/m4.rds")
```



